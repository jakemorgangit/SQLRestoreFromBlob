<UserControl x:Class="SQLRestoreFromBlob.Views.ServerManagerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:SQLRestoreFromBlob.Converters"
             xmlns:models="clr-namespace:SQLRestoreFromBlob.Models">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVis" />
        <converters:NullToVisibilityConverter x:Key="NullToVis" />
        <converters:EnumToBoolConverter x:Key="EnumToBool" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
            <TextBlock Text="SQL Server Connections"
                       Style="{StaticResource HeaderText}" />
            <TextBlock Text="Manage SQL Server connections for executing restore scripts and reading backup metadata."
                       Style="{StaticResource SecondaryText}"
                       Margin="0,4,0,0" />
        </StackPanel>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="280" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Server List -->
            <Border Grid.Column="0" Style="{StaticResource CardBorder}" Margin="0,0,16,0">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top"
                               Text="Saved Servers"
                               Style="{StaticResource SubHeaderText}"
                               Margin="0,0,0,12" />

                    <StackPanel DockPanel.Dock="Bottom" Margin="0,12,0,0">
                        <Button Content="+ Add Server"
                                Style="{StaticResource PrimaryButton}"
                                Command="{Binding AddNewCommand}"
                                HorizontalAlignment="Stretch" />
                    </StackPanel>

                    <ListBox ItemsSource="{Binding Servers}"
                             SelectedItem="{Binding SelectedServer}"
                             Background="Transparent"
                             BorderThickness="0"
                             Foreground="{StaticResource PrimaryTextBrush}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="4,6">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="&#x26C1;" FontSize="14" Margin="0,0,8,0"
                                                   VerticalAlignment="Center"
                                                   Foreground="{StaticResource SecondaryTextBrush}" />
                                        <TextBlock Text="{Binding Name}"
                                                   FontWeight="SemiBold"
                                                   Foreground="{StaticResource PrimaryTextBrush}" />
                                    </StackPanel>
                                    <TextBlock Text="{Binding DisplayText}"
                                               Style="{StaticResource SecondaryText}"
                                               Margin="22,2,0,0" />
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="Background" Value="Transparent" />
                                <Setter Property="Padding" Value="4" />
                                <Setter Property="Cursor" Value="Hand" />
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <Border x:Name="border"
                                                    Background="{TemplateBinding Background}"
                                                    CornerRadius="4"
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter />
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="border" Property="Background"
                                                            Value="{StaticResource SidebarItemHoverBrush}" />
                                                </Trigger>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter TargetName="border" Property="Background"
                                                            Value="{StaticResource SidebarItemActiveBrush}" />
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                    </ListBox>
                </DockPanel>
            </Border>

            <!-- Detail / Edit Panel -->
            <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <!-- Connected Banner -->
                    <Border Background="#1A3D1F"
                            CornerRadius="6"
                            Padding="16,10"
                            Margin="0,0,0,16"
                            Visibility="{Binding IsConnected, Converter={StaticResource BoolToVis}}">
                        <StackPanel Orientation="Horizontal">
                            <Ellipse Width="10" Height="10"
                                     Fill="{StaticResource SuccessBrush}"
                                     VerticalAlignment="Center" Margin="0,0,10,0" />
                            <TextBlock Text="{Binding ConnectedServerDisplay, StringFormat='Connected to {0}'}"
                                       Foreground="{StaticResource SuccessBrush}"
                                       FontWeight="SemiBold" VerticalAlignment="Center" />
                            <Button Content="Disconnect"
                                    Style="{StaticResource SecondaryButton}"
                                    Command="{Binding DisconnectCommand}"
                                    Margin="16,0,0,0"
                                    Padding="12,4" />
                        </StackPanel>
                    </Border>

                    <!-- View mode -->
                    <Border Style="{StaticResource CardBorder}"
                            Visibility="{Binding IsEditing, Converter={StaticResource BoolToVis}, ConverterParameter=Invert}">
                        <StackPanel>
                            <StackPanel Visibility="{Binding SelectedServer, Converter={StaticResource NullToVis}, ConverterParameter=Invert}">
                                <TextBlock Text="No server selected"
                                           Style="{StaticResource SecondaryText}"
                                           HorizontalAlignment="Center"
                                           Margin="0,40,0,8" />
                                <TextBlock Text="Add a new server or select one from the list."
                                           Style="{StaticResource SecondaryText}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>

                            <StackPanel Visibility="{Binding SelectedServer, Converter={StaticResource NullToVis}}">
                                <TextBlock Text="{Binding SelectedServer.Name}"
                                           Style="{StaticResource HeaderText}"
                                           Margin="0,0,0,16" />

                                <TextBlock Text="SERVER" Style="{StaticResource LabelText}" />
                                <TextBlock Text="{Binding SelectedServer.ServerName}"
                                           Style="{StaticResource BodyText}"
                                           Margin="0,0,0,12" />

                                <TextBlock Text="AUTHENTICATION" Style="{StaticResource LabelText}" />
                                <TextBlock Text="{Binding SelectedServer.DisplayText}"
                                           Style="{StaticResource BodyText}"
                                           Margin="0,0,0,16" />

                                <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                    <Button Content="Connect"
                                            Style="{StaticResource SuccessButton}"
                                            Command="{Binding ConnectCommand}"
                                            Margin="0,0,8,0" />
                                    <Button Content="Edit"
                                            Style="{StaticResource SecondaryButton}"
                                            Command="{Binding EditCommand}"
                                            Margin="0,0,8,0" />
                                    <Button Content="Test"
                                            Style="{StaticResource PrimaryButton}"
                                            Command="{Binding TestConnectionCommand}"
                                            Margin="0,0,8,0" />
                                    <Button Content="Delete"
                                            Style="{StaticResource DangerButton}"
                                            Command="{Binding DeleteCommand}" />
                                </StackPanel>

                                <Border Background="{StaticResource InputBackgroundBrush}"
                                        CornerRadius="4"
                                        Padding="12,8"
                                        Margin="0,16,0,0"
                                        Visibility="{Binding TestResult, Converter={StaticResource NullToVis}}">
                                    <TextBlock Text="{Binding TestResult}"
                                               Style="{StaticResource BodyText}"
                                               TextWrapping="Wrap" />
                                </Border>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Edit Form -->
                    <Border Style="{StaticResource CardBorder}"
                            Visibility="{Binding IsEditing, Converter={StaticResource BoolToVis}}">
                        <StackPanel>
                            <TextBlock Text="Server Details"
                                       Style="{StaticResource SubHeaderText}"
                                       Margin="0,0,0,16" />

                            <TextBlock Text="DISPLAY NAME" Style="{StaticResource LabelText}" />
                            <TextBox Text="{Binding EditName, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Margin="0,0,0,16" />

                            <TextBlock Text="SERVER NAME / IP" Style="{StaticResource LabelText}" />
                            <TextBlock Text="e.g. myserver.database.windows.net or 10.0.0.1\SQLEXPRESS"
                                       Style="{StaticResource SecondaryText}"
                                       FontSize="11" Margin="0,0,0,4" />
                            <TextBox Text="{Binding EditServerName, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Margin="0,0,0,16" />

                            <TextBlock Text="AUTHENTICATION MODE" Style="{StaticResource LabelText}" />
                            <StackPanel Margin="0,4,0,16">
                                <RadioButton Content="Windows Authentication"
                                             Style="{StaticResource DarkRadioButton}"
                                             IsChecked="{Binding EditAuthMode, Converter={StaticResource EnumToBool}, ConverterParameter=WindowsAuth}"
                                             Margin="0,0,0,8"
                                             GroupName="AuthMode" />
                                <RadioButton Content="SQL Server Authentication"
                                             Style="{StaticResource DarkRadioButton}"
                                             IsChecked="{Binding EditAuthMode, Converter={StaticResource EnumToBool}, ConverterParameter=SqlAuth}"
                                             GroupName="AuthMode" />
                            </StackPanel>

                            <!-- SQL Auth Fields -->
                            <StackPanel Visibility="{Binding IsSqlAuth, Converter={StaticResource BoolToVis}}">
                                <TextBlock Text="USERNAME" Style="{StaticResource LabelText}" />
                                <TextBox Text="{Binding EditUsername, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource DarkTextBox}"
                                         Margin="0,0,0,16" />

                                <TextBlock Text="PASSWORD" Style="{StaticResource LabelText}" />
                                <PasswordBox x:Name="PasswordInput"
                                             Style="{StaticResource DarkPasswordBox}"
                                             Margin="0,0,0,16" />
                            </StackPanel>

                            <!-- Encryption Options -->
                            <TextBlock Text="ENCRYPTION" Style="{StaticResource LabelText}" />
                            <StackPanel Margin="0,4,0,16">
                                <RadioButton Content="Encrypt: Yes (Mandatory)"
                                             Style="{StaticResource DarkRadioButton}"
                                             IsChecked="{Binding EditEncrypt, Converter={StaticResource EnumToBool}, ConverterParameter=Yes}"
                                             Margin="0,0,0,6"
                                             GroupName="EncryptMode"
                                             ToolTip="Encrypts the connection to SQL Server. Recommended for all remote connections." />
                                <RadioButton Content="Encrypt: No (Optional)"
                                             Style="{StaticResource DarkRadioButton}"
                                             IsChecked="{Binding EditEncrypt, Converter={StaticResource EnumToBool}, ConverterParameter=No}"
                                             Margin="0,0,0,6"
                                             GroupName="EncryptMode"
                                             ToolTip="Connection encryption is optional. The server decides whether to encrypt." />
                                <RadioButton Content="Encrypt: Strict"
                                             Style="{StaticResource DarkRadioButton}"
                                             IsChecked="{Binding EditEncrypt, Converter={StaticResource EnumToBool}, ConverterParameter=Strict}"
                                             GroupName="EncryptMode"
                                             ToolTip="TDS 8.0 strict encryption. Requires SQL Server 2022+ with a valid TLS certificate." />
                            </StackPanel>

                            <CheckBox Content="Trust Server Certificate"
                                      IsChecked="{Binding EditTrustServerCert}"
                                      Style="{StaticResource DarkCheckBox}"
                                      Margin="0,0,0,16"
                                      ToolTip="When enabled, the server certificate is accepted without validation. Common for development and self-signed certificates. Disable for production environments with valid CA-issued certificates." />

                            <TextBlock Text="CONNECTION TIMEOUT (SECONDS)" Style="{StaticResource LabelText}" />
                            <TextBox Text="{Binding EditTimeout, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Width="100"
                                     HorizontalAlignment="Left"
                                     Margin="0,0,0,16" />

                            <TextBlock Text="{Binding ErrorMessage}"
                                       Foreground="{StaticResource ErrorBrush}"
                                       Visibility="{Binding HasError, Converter={StaticResource BoolToVis}}"
                                       Margin="0,0,0,12"
                                       TextWrapping="Wrap" />

                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                <Button Content="Save"
                                        Style="{StaticResource SuccessButton}"
                                        Command="{Binding SaveCommand}"
                                        Margin="0,0,8,0" />
                                <Button Content="Test Connection"
                                        Style="{StaticResource PrimaryButton}"
                                        Command="{Binding TestConnectionCommand}"
                                        Margin="0,0,8,0" />
                                <Button Content="Cancel"
                                        Style="{StaticResource SecondaryButton}"
                                        Command="{Binding CancelEditCommand}" />
                            </StackPanel>

                            <Border Background="{StaticResource InputBackgroundBrush}"
                                    CornerRadius="4"
                                    Padding="12,8"
                                    Margin="0,16,0,0"
                                    Visibility="{Binding TestResult, Converter={StaticResource NullToVis}}">
                                <TextBlock Text="{Binding TestResult}"
                                           Style="{StaticResource BodyText}"
                                           TextWrapping="Wrap" />
                            </Border>
                        </StackPanel>
                    </Border>

                    <Border Background="#80000000"
                            CornerRadius="6"
                            Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}"
                            Margin="0,16,0,0">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Margin="20">
                            <TextBlock Text="Connecting..."
                                       Style="{StaticResource BodyText}"
                                       HorizontalAlignment="Center" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>
