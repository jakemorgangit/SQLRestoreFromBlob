<UserControl x:Class="SQLRestoreFromBlob.Views.RestoreView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:SQLRestoreFromBlob.Converters">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVis" />
        <converters:NullToVisibilityConverter x:Key="NullToVis" />
        <converters:EnumToBoolConverter x:Key="EnumToBool" />
        <converters:BackupTypeToColorConverter x:Key="TypeToColor" />
    </UserControl.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel>
            <!-- Header -->
            <StackPanel Margin="0,0,0,20">
                <TextBlock Text="Restore Database"
                           Style="{StaticResource HeaderText}" />
                <TextBlock Text="Build a point-in-time restore chain, generate T-SQL, and optionally execute against a connected server."
                           Style="{StaticResource SecondaryText}"
                           Margin="0,4,0,0" />
            </StackPanel>

            <!-- Step 1: Container + Load -->
            <Border Style="{StaticResource CardBorder}" Margin="0,0,0,16">
                <StackPanel>
                    <TextBlock Text="1. SELECT SOURCE"
                               Style="{StaticResource SubHeaderText}"
                               Margin="0,0,0,12" />

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Margin="0,0,12,0">
                            <TextBlock Text="BLOB CONTAINER" Style="{StaticResource LabelText}" />
                            <ComboBox ItemsSource="{Binding Containers}"
                                      SelectedItem="{Binding SelectedContainer}"
                                      DisplayMemberPath="Name"
                                      Style="{StaticResource DarkComboBox}" />
                        </StackPanel>

                        <Button Grid.Column="1"
                                Content="Load Backups"
                                Style="{StaticResource PrimaryButton}"
                                Command="{Binding LoadBackupsCommand}"
                                VerticalAlignment="Bottom" />
                    </Grid>

                    <!-- Backup summary after load -->
                    <Grid Margin="0,16,0,0"
                          Visibility="{Binding BackupsLoaded, Converter={StaticResource BoolToVis}}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0" Orientation="Horizontal">
                            <Border Background="{StaticResource AccentBrush}" CornerRadius="3" Padding="8,3" Margin="0,0,8,0">
                                <TextBlock Text="{Binding FullCount}" Foreground="White" FontWeight="Bold" FontSize="12" />
                            </Border>
                            <TextBlock Text="Full backups" Style="{StaticResource BodyText}" VerticalAlignment="Center" />
                        </StackPanel>
                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                            <Border Background="{StaticResource WarningBrush}" CornerRadius="3" Padding="8,3" Margin="0,0,8,0">
                                <TextBlock Text="{Binding DiffCount}" Foreground="White" FontWeight="Bold" FontSize="12" />
                            </Border>
                            <TextBlock Text="Diff backups" Style="{StaticResource BodyText}" VerticalAlignment="Center" />
                        </StackPanel>
                        <StackPanel Grid.Column="2" Orientation="Horizontal">
                            <Border Background="{StaticResource SuccessBrush}" CornerRadius="3" Padding="8,3" Margin="0,0,8,0">
                                <TextBlock Text="{Binding LogCount}" Foreground="White" FontWeight="Bold" FontSize="12" />
                            </Border>
                            <TextBlock Text="Log backups" Style="{StaticResource BodyText}" VerticalAlignment="Center" />
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Step 2: Timeline Picker -->
            <Border Style="{StaticResource CardBorder}" Margin="0,0,0,16"
                    Visibility="{Binding BackupsLoaded, Converter={StaticResource BoolToVis}}">
                <StackPanel>
                    <TextBlock Text="2. POINT-IN-TIME TARGET"
                               Style="{StaticResource SubHeaderText}"
                               Margin="0,0,0,12" />

                    <TextBlock Style="{StaticResource SecondaryText}" Margin="0,0,0,8">
                        <Run Text="Available window: " />
                        <Run Text="{Binding TimelineMin, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}" FontWeight="SemiBold" Foreground="{StaticResource PrimaryTextBrush}" />
                        <Run Text=" to " />
                        <Run Text="{Binding TimelineMax, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}" FontWeight="SemiBold" Foreground="{StaticResource PrimaryTextBrush}" />
                    </TextBlock>

                    <!-- Timeline Slider -->
                    <Grid Margin="0,8,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <Slider Grid.Row="0"
                                Minimum="0" Maximum="100"
                                Value="{Binding TimelineSliderValue}"
                                Style="{StaticResource TimelineSlider}"
                                TickFrequency="1"
                                IsSnapToTickEnabled="False"
                                Margin="0,0,0,8" />

                        <Grid Grid.Row="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Orientation="Horizontal">
                                <TextBlock Text="Selected: " Style="{StaticResource SecondaryText}" VerticalAlignment="Center" />
                                <TextBlock Text="{Binding SelectedDateTimeDisplay}"
                                           FontSize="16" FontWeight="Bold"
                                           Foreground="{StaticResource AccentBrush}"
                                           VerticalAlignment="Center" />
                            </StackPanel>

                            <TextBlock Grid.Column="1"
                                       Text="{Binding ChainSummary}"
                                       Style="{StaticResource SecondaryText}"
                                       VerticalAlignment="Center" />
                        </Grid>
                    </Grid>

                    <!-- Restore Chain Visualization -->
                    <Border Background="{StaticResource InputBackgroundBrush}"
                            CornerRadius="4"
                            Padding="12"
                            Margin="0,16,0,0"
                            Visibility="{Binding HasValidChain, Converter={StaticResource BoolToVis}}">
                        <StackPanel>
                            <TextBlock Text="RESTORE CHAIN" Style="{StaticResource LabelText}" Margin="0,0,0,8" />
                            <ItemsControl ItemsSource="{Binding ChainFiles}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" Margin="0,3">
                                            <Border Background="{Binding Type, Converter={StaticResource TypeToColor}}"
                                                    CornerRadius="3" Padding="6,2" MinWidth="80" Opacity="0.85">
                                                <TextBlock Text="{Binding TypeDisplay}"
                                                           Foreground="White" FontSize="11"
                                                           FontWeight="SemiBold"
                                                           HorizontalAlignment="Center" />
                                            </Border>
                                            <TextBlock Text="{Binding BlobName}"
                                                       Style="{StaticResource BodyText}"
                                                       Margin="10,0,16,0"
                                                       VerticalAlignment="Center" />
                                            <TextBlock Text="{Binding SizeDisplay}"
                                                       Style="{StaticResource SecondaryText}"
                                                       VerticalAlignment="Center"
                                                       Margin="0,0,16,0" />
                                            <TextBlock Text="{Binding EffectiveDate, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}"
                                                       Style="{StaticResource SecondaryText}"
                                                       VerticalAlignment="Center" />
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>

            <!-- Step 3: Restore Options -->
            <Border Style="{StaticResource CardBorder}" Margin="0,0,0,16"
                    Visibility="{Binding BackupsLoaded, Converter={StaticResource BoolToVis}}">
                <StackPanel>
                    <TextBlock Text="3. RESTORE OPTIONS"
                               Style="{StaticResource SubHeaderText}"
                               Margin="0,0,0,16" />

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Left Column -->
                        <StackPanel Grid.Column="0" Margin="0,0,16,0">
                            <TextBlock Text="TARGET DATABASE NAME" Style="{StaticResource LabelText}" />
                            <TextBox Text="{Binding TargetDatabaseName, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Margin="0,0,0,16"
                                     ToolTip="The name of the database to restore to. Can differ from the original database name." />

                            <CheckBox Content="WITH REPLACE"
                                      IsChecked="{Binding WithReplace}"
                                      Style="{StaticResource DarkCheckBox}"
                                      Margin="0,0,0,12"
                                      ToolTip="Overwrite the existing database even if it already exists. Required when restoring over an existing database that was created from a different backup set." />

                            <CheckBox Content="Disconnect Sessions"
                                      IsChecked="{Binding DisconnectSessions}"
                                      Style="{StaticResource DarkCheckBox}"
                                      Margin="0,0,0,12"
                                      ToolTip="Executes ALTER DATABASE SET SINGLE_USER WITH ROLLBACK IMMEDIATE before restore to force disconnect all active sessions. The database is returned to MULTI_USER after restore completes." />

                            <CheckBox Content="KEEP_REPLICATION"
                                      IsChecked="{Binding KeepReplication}"
                                      Style="{StaticResource DarkCheckBox}"
                                      Margin="0,0,0,12"
                                      ToolTip="Preserves replication settings during restore. Required when restoring a published database to a server other than where it was created." />

                            <CheckBox Content="ENABLE_BROKER"
                                      IsChecked="{Binding EnableBroker}"
                                      Style="{StaticResource DarkCheckBox}"
                                      Margin="0,0,0,12"
                                      ToolTip="Enables Service Broker with the existing contract. Use this when you need Service Broker messaging immediately after restore." />

                            <CheckBox Content="NEW_BROKER"
                                      IsChecked="{Binding NewBroker}"
                                      Style="{StaticResource DarkCheckBox}"
                                      Margin="0,0,0,12"
                                      ToolTip="Creates a new Service Broker identifier. All existing conversations are ended without producing end-dialog messages. Use this to avoid conflicts with the source server's broker." />
                        </StackPanel>

                        <!-- Right Column -->
                        <StackPanel Grid.Column="1">
                            <TextBlock Text="RECOVERY MODE" Style="{StaticResource LabelText}" />
                            <StackPanel Margin="0,4,0,16">
                                <RadioButton Content="RECOVERY"
                                             Style="{StaticResource DarkRadioButton}"
                                             IsChecked="{Binding RecoveryMode, Converter={StaticResource EnumToBool}, ConverterParameter=Recovery}"
                                             Margin="0,0,0,6"
                                             GroupName="RecoveryMode"
                                             ToolTip="Database is fully recovered and ready for use. No additional restores can be applied. This is the default for the final restore step." />
                                <RadioButton Content="NORECOVERY"
                                             Style="{StaticResource DarkRadioButton}"
                                             IsChecked="{Binding RecoveryMode, Converter={StaticResource EnumToBool}, ConverterParameter=NoRecovery}"
                                             Margin="0,0,0,6"
                                             GroupName="RecoveryMode"
                                             ToolTip="Leaves the database in a restoring state so additional backup files (differential or log) can be applied. The database is not accessible until RECOVERY is applied." />
                                <RadioButton Content="STANDBY"
                                             Style="{StaticResource DarkRadioButton}"
                                             IsChecked="{Binding RecoveryMode, Converter={StaticResource EnumToBool}, ConverterParameter=Standby}"
                                             GroupName="RecoveryMode"
                                             ToolTip="Leaves the database in read-only mode with an undo file. Allows additional restores while permitting read-only queries. Useful for log shipping standby scenarios." />
                            </StackPanel>

                            <TextBlock Text="STANDBY FILE PATH" Style="{StaticResource LabelText}"
                                       Visibility="{Binding IsStandbyMode, Converter={StaticResource BoolToVis}}" />
                            <TextBox Text="{Binding StandbyFilePath, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Margin="0,0,0,16"
                                     Visibility="{Binding IsStandbyMode, Converter={StaticResource BoolToVis}}"
                                     ToolTip="Full path for the standby undo file. Required when using STANDBY recovery mode." />

                            <TextBlock Text="STATS PERCENT" Style="{StaticResource LabelText}" />
                            <TextBox Text="{Binding StatsPercent, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Width="80" HorizontalAlignment="Left"
                                     Margin="0,0,0,16"
                                     ToolTip="Progress reporting interval (percentage). STATS = 10 means SQL Server reports progress every 10% of the restore. Lower values give more frequent updates." />

                            <TextBlock Text="SQL CREDENTIAL NAME" Style="{StaticResource LabelText}" />
                            <TextBox Text="{Binding SqlCredentialName, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Margin="0,0,0,16"
                                     ToolTip="Name of the SQL Server credential used to authenticate against Azure Blob Storage. This credential is created on the SQL Server instance with the SAS token." />
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Step 4: Generate + Execute -->
            <Border Style="{StaticResource CardBorder}" Margin="0,0,0,16"
                    Visibility="{Binding BackupsLoaded, Converter={StaticResource BoolToVis}}">
                <StackPanel>
                    <TextBlock Text="4. GENERATE &amp; EXECUTE"
                               Style="{StaticResource SubHeaderText}"
                               Margin="0,0,0,16" />

                    <!-- Action Buttons -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                        <Button Content="Generate Script"
                                Style="{StaticResource PrimaryButton}"
                                Command="{Binding GenerateScriptCommand}"
                                Margin="0,0,8,0"
                                ToolTip="Generate the complete T-SQL restore script based on the selected chain and options." />
                        <Button Content="Copy to Clipboard"
                                Style="{StaticResource SecondaryButton}"
                                Command="{Binding CopyScriptCommand}"
                                IsEnabled="{Binding HasScript}"
                                Margin="0,0,8,0" />
                        <Button Content="Save to File"
                                Style="{StaticResource SecondaryButton}"
                                Command="{Binding SaveScriptCommand}"
                                IsEnabled="{Binding HasScript}"
                                Margin="0,0,8,0" />
                        <Button Content="Execute on Server"
                                Style="{StaticResource DangerButton}"
                                Command="{Binding ExecuteScriptCommand}"
                                IsEnabled="{Binding IsConnectedToServer}"
                                ToolTip="Execute the generated script against the connected SQL Server instance. This will perform the actual database restore." />
                    </StackPanel>

                    <!-- Not connected warning -->
                    <Border Background="{StaticResource DangerBackgroundBrush}"
                            CornerRadius="4"
                            Padding="12,8"
                            Margin="0,0,0,12"
                            Visibility="{Binding IsConnectedToServer, Converter={StaticResource BoolToVis}, ConverterParameter=Invert}">
                        <TextBlock Style="{StaticResource SecondaryText}">
                            <Run Text="&#x26A0;" Foreground="{StaticResource WarningBrush}" />
                            <Run Text=" Connect to a SQL Server instance (SQL Servers tab) to enable script execution." />
                        </TextBlock>
                    </Border>

                    <!-- Error display -->
                    <TextBlock Text="{Binding ErrorMessage}"
                               Foreground="{StaticResource ErrorBrush}"
                               Visibility="{Binding HasError, Converter={StaticResource BoolToVis}}"
                               Margin="0,0,0,12"
                               TextWrapping="Wrap" />

                    <!-- Script Output -->
                    <Border Background="{StaticResource InputBackgroundBrush}"
                            CornerRadius="4"
                            Padding="0"
                            Visibility="{Binding HasScript, Converter={StaticResource BoolToVis}}">
                        <TextBox Text="{Binding GeneratedScript, Mode=OneWay}"
                                 Style="{StaticResource DarkTextBox}"
                                 IsReadOnly="True"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"
                                 VerticalScrollBarVisibility="Auto"
                                 MaxHeight="400"
                                 FontFamily="Cascadia Code, Consolas, Courier New"
                                 FontSize="12" />
                    </Border>

                    <!-- Execution Log -->
                    <Border Background="{StaticResource InputBackgroundBrush}"
                            CornerRadius="4"
                            Padding="0"
                            Margin="0,12,0,0"
                            Visibility="{Binding ExecutionLog, Converter={StaticResource NullToVis}}">
                        <StackPanel>
                            <TextBlock Text="EXECUTION LOG" Style="{StaticResource LabelText}" Margin="12,8,0,4" />
                            <TextBox Text="{Binding ExecutionLog, Mode=OneWay}"
                                     Style="{StaticResource DarkTextBox}"
                                     IsReadOnly="True"
                                     TextWrapping="Wrap"
                                     AcceptsReturn="True"
                                     VerticalScrollBarVisibility="Auto"
                                     MaxHeight="300"
                                     FontFamily="Cascadia Code, Consolas, Courier New"
                                     FontSize="12" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>

            <!-- Loading -->
            <Border Background="#80000000"
                    CornerRadius="6"
                    Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}"
                    Padding="20">
                <TextBlock Text="Loading..."
                           Style="{StaticResource BodyText}"
                           HorizontalAlignment="Center" />
            </Border>

            <!-- Status -->
            <TextBlock Text="{Binding StatusMessage}"
                       Style="{StaticResource SecondaryText}"
                       Margin="0,4,0,16"
                       Visibility="{Binding StatusMessage, Converter={StaticResource NullToVis}}" />
        </StackPanel>
    </ScrollViewer>
</UserControl>
