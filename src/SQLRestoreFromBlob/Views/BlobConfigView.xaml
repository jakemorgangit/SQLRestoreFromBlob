<UserControl x:Class="SQLRestoreFromBlob.Views.BlobConfigView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:SQLRestoreFromBlob.Converters">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVis" />
        <converters:NullToVisibilityConverter x:Key="NullToVis" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
            <TextBlock Text="Blob Storage Configuration"
                       Style="{StaticResource HeaderText}" />
            <TextBlock Text="Configure Azure Blob Storage containers and SAS tokens for backup access."
                       Style="{StaticResource SecondaryText}"
                       Margin="0,4,0,0" />
        </StackPanel>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="280" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Container List -->
            <Border Grid.Column="0" Style="{StaticResource CardBorder}" Margin="0,0,16,0">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top"
                               Text="Saved Containers"
                               Style="{StaticResource SubHeaderText}"
                               Margin="0,0,0,12" />

                    <StackPanel DockPanel.Dock="Bottom" Margin="0,12,0,0">
                        <Button Content="+ Add Container"
                                Style="{StaticResource PrimaryButton}"
                                Command="{Binding AddNewCommand}"
                                HorizontalAlignment="Stretch" />
                    </StackPanel>

                    <ListBox ItemsSource="{Binding Containers}"
                             SelectedItem="{Binding SelectedContainer}"
                             Background="Transparent"
                             BorderThickness="0"
                             Foreground="{StaticResource PrimaryTextBrush}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="4,6">
                                    <StackPanel Orientation="Horizontal">
                                        <Ellipse Width="8" Height="8"
                                                 Fill="{StaticResource SuccessBrush}"
                                                 VerticalAlignment="Center"
                                                 Margin="0,0,8,0" />
                                        <TextBlock Text="{Binding Name}"
                                                   FontWeight="SemiBold"
                                                   Foreground="{StaticResource PrimaryTextBrush}" />
                                    </StackPanel>
                                    <TextBlock Text="{Binding ContainerUrl}"
                                               Style="{StaticResource SecondaryText}"
                                               TextTrimming="CharacterEllipsis"
                                               Margin="16,2,0,0"
                                               MaxWidth="220" />
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="Background" Value="Transparent" />
                                <Setter Property="Padding" Value="4" />
                                <Setter Property="Cursor" Value="Hand" />
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <Border x:Name="border"
                                                    Background="{TemplateBinding Background}"
                                                    CornerRadius="4"
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter />
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="border" Property="Background"
                                                            Value="{StaticResource SidebarItemHoverBrush}" />
                                                </Trigger>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter TargetName="border" Property="Background"
                                                            Value="{StaticResource SidebarItemActiveBrush}" />
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                    </ListBox>
                </DockPanel>
            </Border>

            <!-- Detail / Edit Panel -->
            <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <!-- SAS Expiry Warning -->
                    <Border Background="{StaticResource DangerBackgroundBrush}"
                            CornerRadius="6"
                            Padding="16,12"
                            Margin="0,0,0,16"
                            Visibility="{Binding IsSasExpired, Converter={StaticResource BoolToVis}}">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#x26A0;" FontSize="16" Foreground="{StaticResource ErrorBrush}"
                                           VerticalAlignment="Center" Margin="0,0,8,0" />
                                <TextBlock Text="SAS Token Expired"
                                           FontWeight="SemiBold"
                                           Foreground="{StaticResource ErrorBrush}" />
                            </StackPanel>
                            <TextBlock Text="{Binding SasExpiryText}"
                                       Style="{StaticResource SecondaryText}"
                                       Margin="24,4,0,8" />
                            <Button Content="Refresh Token"
                                    Style="{StaticResource DangerButton}"
                                    Command="{Binding RefreshTokenCommand}"
                                    HorizontalAlignment="Left"
                                    Margin="24,0,0,0" />
                        </StackPanel>
                    </Border>

                    <!-- Selected Container Info (not editing) -->
                    <Border Style="{StaticResource CardBorder}"
                            Visibility="{Binding IsEditing, Converter={StaticResource BoolToVis}, ConverterParameter=Invert}">
                        <StackPanel>
                            <!-- Empty state -->
                            <StackPanel Visibility="{Binding SelectedContainer, Converter={StaticResource NullToVis}, ConverterParameter=Invert}">
                                <TextBlock Text="No container selected"
                                           Style="{StaticResource SecondaryText}"
                                           HorizontalAlignment="Center"
                                           Margin="0,40,0,8" />
                                <TextBlock Text="Add a new container or select one from the list."
                                           Style="{StaticResource SecondaryText}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>

                            <!-- Detail state -->
                            <StackPanel Visibility="{Binding SelectedContainer, Converter={StaticResource NullToVis}}">
                                <TextBlock Text="{Binding SelectedContainer.Name}"
                                           Style="{StaticResource HeaderText}"
                                           Margin="0,0,0,16" />

                                <TextBlock Text="CONTAINER URL" Style="{StaticResource LabelText}" />
                                <TextBlock Text="{Binding SelectedContainer.ContainerUrl}"
                                           Style="{StaticResource BodyText}"
                                           TextWrapping="Wrap"
                                           Margin="0,0,0,12" />

                                <TextBlock Text="STORAGE ACCOUNT" Style="{StaticResource LabelText}" />
                                <TextBlock Text="{Binding SelectedContainer.StorageAccountName}"
                                           Style="{StaticResource BodyText}"
                                           Margin="0,0,0,12" />

                                <TextBlock Text="SAS TOKEN STATUS" Style="{StaticResource LabelText}" />
                                <TextBlock Text="{Binding SasExpiryText}"
                                           Style="{StaticResource BodyText}"
                                           Margin="0,0,0,16" />

                                <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                    <Button Content="Edit"
                                            Style="{StaticResource SecondaryButton}"
                                            Command="{Binding EditCommand}"
                                            Margin="0,0,8,0" />
                                    <Button Content="Test Connection"
                                            Style="{StaticResource PrimaryButton}"
                                            Command="{Binding TestConnectionCommand}"
                                            Margin="0,0,8,0" />
                                    <Button Content="Delete"
                                            Style="{StaticResource DangerButton}"
                                            Command="{Binding DeleteCommand}" />
                                </StackPanel>

                                <!-- Test Result -->
                                <Border Background="{StaticResource InputBackgroundBrush}"
                                        CornerRadius="4"
                                        Padding="12,8"
                                        Margin="0,16,0,0"
                                        Visibility="{Binding TestResult, Converter={StaticResource NullToVis}}">
                                    <TextBlock Text="{Binding TestResult}"
                                               Style="{StaticResource BodyText}"
                                               TextWrapping="Wrap" />
                                </Border>

                                <!-- Container Summary -->
                                <Border Style="{StaticResource CardBorder}"
                                        Margin="0,16,0,0"
                                        Visibility="{Binding ContainerSummary, Converter={StaticResource NullToVis}}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                                            <TextBlock Text="{Binding ContainerSummary.FullBackups}"
                                                       FontSize="24" FontWeight="Bold"
                                                       Foreground="{StaticResource AccentBrush}"
                                                       HorizontalAlignment="Center" />
                                            <TextBlock Text="Full" Style="{StaticResource SecondaryText}"
                                                       HorizontalAlignment="Center" />
                                        </StackPanel>
                                        <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                                            <TextBlock Text="{Binding ContainerSummary.DiffBackups}"
                                                       FontSize="24" FontWeight="Bold"
                                                       Foreground="{StaticResource WarningBrush}"
                                                       HorizontalAlignment="Center" />
                                            <TextBlock Text="Diff" Style="{StaticResource SecondaryText}"
                                                       HorizontalAlignment="Center" />
                                        </StackPanel>
                                        <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                                            <TextBlock Text="{Binding ContainerSummary.LogBackups}"
                                                       FontSize="24" FontWeight="Bold"
                                                       Foreground="{StaticResource SuccessBrush}"
                                                       HorizontalAlignment="Center" />
                                            <TextBlock Text="Log" Style="{StaticResource SecondaryText}"
                                                       HorizontalAlignment="Center" />
                                        </StackPanel>
                                        <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                                            <TextBlock Text="{Binding ContainerSummary.TotalSizeDisplay}"
                                                       FontSize="18" FontWeight="Bold"
                                                       Foreground="{StaticResource PrimaryTextBrush}"
                                                       HorizontalAlignment="Center" />
                                            <TextBlock Text="Total" Style="{StaticResource SecondaryText}"
                                                       HorizontalAlignment="Center" />
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Edit Form -->
                    <Border Style="{StaticResource CardBorder}"
                            Visibility="{Binding IsEditing, Converter={StaticResource BoolToVis}}">
                        <StackPanel>
                            <TextBlock Margin="0,0,0,16">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock" BasedOn="{StaticResource SubHeaderText}">
                                        <Setter Property="Text" Value="Edit Container" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsNew}" Value="True">
                                                <Setter Property="Text" Value="Add Container" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>

                            <TextBlock Text="DISPLAY NAME" Style="{StaticResource LabelText}" />
                            <TextBox Text="{Binding EditName, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Margin="0,0,0,16" />

                            <TextBlock Text="CONTAINER URL" Style="{StaticResource LabelText}" />
                            <TextBlock Text="e.g. https://myaccount.blob.core.windows.net/backups"
                                       Style="{StaticResource SecondaryText}"
                                       FontSize="11" Margin="0,0,0,4" />
                            <TextBox Text="{Binding EditContainerUrl, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Margin="0,0,0,16" />

                            <TextBlock Text="SAS TOKEN" Style="{StaticResource LabelText}" />
                            <TextBlock Text="The shared access signature token (starting with sv= or ?sv=)"
                                       Style="{StaticResource SecondaryText}"
                                       FontSize="11" Margin="0,0,0,4" />
                            <TextBox Text="{Binding EditSasToken, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource DarkTextBox}"
                                     Margin="0,0,0,16"
                                     TextWrapping="Wrap"
                                     AcceptsReturn="False"
                                     MaxHeight="80"
                                     VerticalScrollBarVisibility="Auto" />

                            <!-- Error display -->
                            <TextBlock Text="{Binding ErrorMessage}"
                                       Foreground="{StaticResource ErrorBrush}"
                                       Visibility="{Binding HasError, Converter={StaticResource BoolToVis}}"
                                       Margin="0,0,0,12"
                                       TextWrapping="Wrap" />

                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                <Button Content="Save"
                                        Style="{StaticResource SuccessButton}"
                                        Command="{Binding SaveCommand}"
                                        Margin="0,0,8,0" />
                                <Button Content="Test Connection"
                                        Style="{StaticResource PrimaryButton}"
                                        Command="{Binding TestConnectionCommand}"
                                        Margin="0,0,8,0" />
                                <Button Content="Cancel"
                                        Style="{StaticResource SecondaryButton}"
                                        Command="{Binding CancelEditCommand}" />
                            </StackPanel>

                            <!-- Test Result in Edit Mode -->
                            <Border Background="{StaticResource InputBackgroundBrush}"
                                    CornerRadius="4"
                                    Padding="12,8"
                                    Margin="0,16,0,0"
                                    Visibility="{Binding TestResult, Converter={StaticResource NullToVis}}">
                                <TextBlock Text="{Binding TestResult}"
                                           Style="{StaticResource BodyText}"
                                           TextWrapping="Wrap" />
                            </Border>
                        </StackPanel>
                    </Border>

                    <!-- Loading Overlay -->
                    <Border Background="#80000000"
                            CornerRadius="6"
                            Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}"
                            Margin="0,16,0,0">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Margin="20">
                            <TextBlock Text="Connecting..."
                                       Style="{StaticResource BodyText}"
                                       HorizontalAlignment="Center" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>
